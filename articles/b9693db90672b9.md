---
title: '【React/TypeScript】Web Speech APIでロボット音声にならない実装方法'
emoji: '🗣️'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: [react, typescript, javascript, api]
published: true
---

## はじめに

Web Speech APIを使って音声読み上げ機能を実装した際に、ロボットのような不自然な音声になる問題に遭遇しました。

この記事では、その問題と解決策、Reactでの実装パターンを共有します。

### 学べること

1. TypeScriptとReactによる、Web Speech API実装方法
2. 音声など実装面で注意すべきこと

＊基本的な今回のAPIの使い方に関して学ぶ場合は以下の記事がおすすめです。
https://developer.mozilla.org/ja/docs/Web/API/Web_Speech_API
https://zenn.dev/micronn/articles/b654ceca1bdf13
https://qiita.com/7shi/items/43452dcd34e57100fc3c

## 問題：ロボット音声になる

```typescript:utils/speak.ts
export function speak(text: string, onEnd?: () => void) {
  const synth = window.speechSynthesis;
  const speech = new SpeechSynthesisUtterance(text);

  speech.lang = 'en-US';
  speech.rate = 1.0;

  speech.onend = () => {
    if(onEnd) onEnd();
  }

  synth.speak(speech);
}
```

```typescript:components/QuestionDisplay.tsx
import { speak } from "@/utils/speak";

export default function QuestionDisplay({ question }: { question: string }) {
  const [play, setPlay] = useState(false);

  const handlePlay = () => {
    setPlay(true);
    speak(question, () => {
      setPlay(false);
    });
  };

  return (
    <div>
      <p>{question}</p>
      <button onClick={handlePlay}>
        再生
      </button>
    </div>
  );
}
```

### 問題点

1. 低品質なぎこちない機械音が再生される

### 原因

1. **voice を指定していない**
   ブラウザには`getVoices()`で取得できる複数の音声が用意されている。
   明示的に指定しないと、デフォルトの低品質な音声が使われる。

2. **音声リストの読み込みを待っていない**
   Chromeは音声リストを非同期で読み込むため、初回実行時は `getVoices()` が空配列を返す。利用可能な音声がない状態で再生されるため、不自然な音声になってしまう。

:::message
**ポイント**
Web Speech APIはブラウザ内部のリソースであり、外部APIではない。
Chromeはページ表示を最優先するため、音声リストの読み込みは後回しになります。
:::

## 解決策

```typescript:utils/speak.ts
export function speak(text: string, onEnd?: () => void) {
  const synth = window.speechSynthesis;

  synth.cancel();

  const startSpeaking = () => {
    const speech = new SpeechSynthesisUtterance(text);
    const voices = synth.getVoices();

    // ブラウザごとに高品質な音声を選択
    const highQualityVoice =
      voices.find(v => v.name === 'Google US English') ||
      voices.find(v => v.name.includes('Samantha')) ||
      voices.find(v => v.lang === 'en-US');

    if (highQualityVoice) {
      speech.voice = highQualityVoice;
    }

    speech.lang = 'en-US';
    speech.rate = 1.0;

    speech.onend = () => {
      if (onEnd) onEnd();
    };

    synth.speak(speech);
  };

  // 音声リストの読み込みを待つ
//   「音声リストある？」
//     ├─ ない → 待ってから実行
//     └─ ある → すぐ実行
  if (synth.getVoices().length === 0) {
    synth.onvoiceschanged = startSpeaking;
  } else {
    startSpeaking();
  }
}
```

```tsx:components/QuestionDisplay.tsx
import { speak } from "@/utils/speak";
import { useState } from "react";

export default function QuestionDisplay({ question }: { question: string }) {
  const [isPlaying, setIsPlaying] = useState(false);

  const handlePlay = () => {
    setIsPlaying(true);
    speak(question, () => {
      setIsPlaying(false);
    });
  };

  return (
    <div>
      <p>{question}</p>
      <button onClick={handlePlay} disabled={isPlaying}>
        {isPlaying ? '再生中...' : '再生'}
      </button>
    </div>
  );
}
```

### 改善ポイント

1. `getVoices()`を使用し、ブラウザの組み込み音声APIを取得
2. **音声リストの読み込みを待つ** - `onvoiceschanged` で読み込み完了を検知
3. **高品質な音声を明示的に選択** - ブラウザごとにフォールバック
4. **再生前に前の音声をキャンセル** - 連続再生時の音声重なりを防止
5. **再生状態の管理** - ボタンの連打防止とUI反映

## Reactでの実装パターン

音声再生はユーザーのボタン操作に対する応答なので、`useEffect`ではなくイベントハンドラで実装しています。

React公式ドキュメントでも、ユーザーアクションへの応答は`useEffect`ではなくイベントハンドラで処理することが推奨されています。
https://ja.react.dev/learn/you-might-not-need-an-effect

## まとめ

Web Speech APIで自然な音声を出すには2点です。

- **音声リストの読み込みを待つ**
- **高品質な音声を明示的に指定する**

この2点を押さえれば、ロボット音声の問題は解決できます。

## 最後に

最近実践してる2つの学習方法として、**Notebook LLMに学習したい公式ドキュメントやPDFをあげて**、音声解説してもらったり、スライド作成してもらいなるべく読むだけでなく視覚的に理解する学習をしてます。もし良ければオススメの学習方法なので実践してみてください！

**GeminiのツールのCanvasを選択肢、文末にプロンプトで｀HTMLとCSSで図解して｀と伝えれば図で説明してくれる**ので、関数の実行タイミングや細かく複雑なものを理解するときはオススメの方法です！
